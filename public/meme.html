<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Meme Video Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/assets/style.css"/>
</head>
<body>
  <header class="nav"><div class="nav-inner"><div class="brand"><span class="dot"></span> Meme Generator</div></div></header>
  <main class="section">
    <div class="card white">
      <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
        <select id="user" style="min-width:240px"></select>
        <label class="muted"><input type="checkbox" id="silent"/> Silent</label>
        <button id="gen" class="btn btn-primary">Generate Preview</button>
        <button id="post" class="btn btn-outline">Post to Instagram</button>
        <div id="status" class="muted"></div>
      </div>
      <div id="holder" style="width:100%;display:flex;justify-content:center;align-items:center;min-height:360px;background:#111;border-radius:8px;margin-top:8px"></div>
      <details style="margin-top:8px"><summary>Debug logs</summary><pre id="logbox" style="max-height:220px;overflow:auto;background:#0b0b0b;color:#ddd;padding:8px;border-radius:6px"></pre></details>
    </div>
  </main>
  <script type="module">
    const statusEl = document.getElementById('status');
    const holder = document.getElementById('holder');
    const user = document.getElementById('user');
    const silent = document.getElementById('silent');
    const genBtn = document.getElementById('gen');
    const postBtn = document.getElementById('post');
    const logbox = document.getElementById('logbox');
    let videoUrl = null;
    function setStatus(s, ok){ statusEl.textContent = s; statusEl.style.color = ok?'#2e7d32':'#b00020'; }
    function appendLog(step, data){ try{ const line = (typeof data==='string')? data : JSON.stringify(data); logbox.textContent += `\n${step}: ${line}`; logbox.scrollTop = logbox.scrollHeight; }catch(_){} }
    async function fetchJsonSafe(url, opts){
      const r = await fetch(url, opts);
      let body=null, txt='';
      try{ body = await r.clone().json(); }catch(_){ try{ txt = await r.clone().text(); }catch(__){ txt=''; } }
      if(!r.ok){
        const rid = r.headers.get('x-vercel-id') || r.headers.get('x-request-id') || '';
        const statusLine = `HTTP ${r.status} ${r.statusText}`;
        const snippet = (txt||'').slice(0,240).replace(/\s+/g,' ').trim();
        const where = body?.where ? ` @${body.where}` : '';
        console.error('RAW_RESPONSE', { status:r.status, statusText:r.statusText, headers:Object.fromEntries(r.headers.entries()), body, text:txt });
        throw new Error(`${statusLine}${where}: ${(body?.error||body?.message||snippet||'Request failed')}${rid? ' #'+rid : ''}`);
      }
      return body||{};
    }
    async function loadAccounts(){
      try{ const r = await fetch('/api/accounts'); const arr = await r.json(); user.innerHTML=''; (arr||[]).forEach(a=>{ const o=document.createElement('option'); o.value=a.username; o.textContent='@'+a.username; user.appendChild(o); }); }
      catch(_){ user.innerHTML='<option value="">(no accounts)</option>'; }
    }
    await loadAccounts();
    genBtn.onclick = async ()=>{
      try{ setStatus('Generating…'); holder.innerHTML=''; videoUrl=null; logbox.textContent=''; const u = user.value.replace('@','').trim(); if(!u) return setStatus('Select @username', false);
        const j = await fetchJsonSafe('/api/video/meme-single', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username: u, allow_silent: silent.checked, debug:true, mode:'render' }) });
        if (j.enqueued && j.job_id){
          appendLog('enqueued', j.job_id);
          setStatus('Queued on Render. Polling…', true);
          const poll = async () => {
            const s = await fetchJsonSafe(`/api/jobs/status?job_id=${encodeURIComponent(j.job_id)}&include_logs=true`);
            appendLog('status', { status: s.status, step: s.step });
            const vid = (s.assets||[]).find(a=>a.kind==='video');
            if (s.status === 'completed' && vid){
              videoUrl = vid.url; holder.innerHTML = `<video controls style="max-width:100%;border-radius:8px"><source src="${videoUrl}" type="video/mp4"/></video>`; setStatus('Preview ready (Render)', true); return;
            }
            if (s.status === 'failed'){ setStatus('Render job failed: '+(s.error||'unknown'), false); return; }
            setTimeout(poll, 1500);
          };
          poll();
          return;
        }
        if (Array.isArray(j.logs)) { j.logs.forEach(l=> appendLog(l.step, l.data)); }
        videoUrl = j.video?.videoUrl || j.video?.url; if(!videoUrl) throw new Error('no video url');
        holder.innerHTML = `<video controls style="max-width:100%;border-radius:8px"><source src="${videoUrl}" type="video/mp4"/></video>`;
        const dbg = j.logs? ('steps: '+ j.logs.map(l=>l.step).join(' → ')) : '';
        setStatus('Preview ready '+dbg, true);
      }catch(e){ appendLog('error', e.message); setStatus((''+e.message).startsWith('HTTP')? e.message : ('Error: '+e.message), false); }
    };
    postBtn.onclick = async ()=>{
      try{ if(!videoUrl) return setStatus('Generate preview first', false); const u = user.value.replace('@','').trim(); if(!u) return setStatus('Select @username', false);
        const out = await fetchJsonSafe('/api/instagram/post-now', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username: u, images:[videoUrl], caption:'' }) });
        setStatus('Posted', true);
      }catch(e){ setStatus('Post failed: '+e.message, false); }
    };
  </script>
</body>
</html>


