<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Random Post Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/style.css">
  <style>
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
    img { width: 100%; border-radius: 8px; height: 260px; object-fit: cover; }
    .controls { display: flex; gap: 8px; margin-bottom: 12px; }
  </style>
</head>
<body>
  <header class="nav"><div class="nav-inner">
    <div class="brand"><span class="dot"></span> EasyPost</div>
    <div class="nav-links">
      <a href="/">Home</a>
      <a href="/managed.html">Managed</a>
      <a href="/sources.html">Sources</a>
      <a href="/random.html">Random</a>
      <a href="/docs.html">Docs</a>
    </div>
  </div></header>
  <main>
  <h2>Random Post Generator</h2>
  <div class="controls">
    <button id="generate" class="btn btn-primary">Generate</button>
    <button id="rerollSelected" class="btn btn-outline">Reroll Selected</button>
    <button id="downloadSelected" class="btn btn-outline">Download Selected</button>
    <button id="downloadAll" class="btn btn-outline">Download All</button>
    <button id="saveSelected" class="btn btn-primary">Save Selected as Post</button>
  </div>
  <div id="caption" style="margin:8px 0 12px"></div>
  <div id="grid" class="grid"></div>

  <script>
    let currentPost = null;
    let currentUserEmail = null;

    function render() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      if (!currentPost) return;
      document.getElementById('caption').textContent = currentPost.caption;
      currentPost.images.forEach(img => {
        const wrap = document.createElement('div');
        wrap.innerHTML = `
          <label style="display:block;margin-bottom:6px"><input type="checkbox" class="sel" value="${img.id}"/> Select</label>
          <img src="${img.imagePath || img.image_path}" alt=""/>
          <div style="font-size:12px;color:#666;margin-top:4px">${img.aesthetic || 'mixed'}</div>
        `;
        grid.appendChild(wrap);
      });
    }

    async function generate() {
      const res = await fetch('/api/generate-any', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ imageCount: 10 }) });
      const data = await res.json();
      if (data.success) { currentPost = data.post; render(); }
    }

    async function rerollSelected() {
      if (!currentPost) return;
      const selectedIds = Array.from(document.querySelectorAll('.sel:checked')).map(cb => parseInt(cb.value));
      if (selectedIds.length === 0) return;
      const allIds = currentPost.images.map(i => i.id);
      const res = await fetch('/api/reroll-any', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ imageIds: selectedIds, allImageIds: allIds }) });
      const data = await res.json();
      if (data.success) {
        let k = 0;
        currentPost.images = currentPost.images.map(img => selectedIds.includes(img.id) ? data.newImages[k++] : img);
        render();
      }
    }

    async function downloadImages(images, type) {
      if (!images || images.length === 0) return;
      const accountUsername = 'random';
      const response = await fetch('/api/download-images', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ images, accountUsername, type })
      });
      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `${accountUsername}_${type}_images_${Date.now()}.zip`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }
    }

    async function downloadSelected() {
      if (!currentPost) return;
      const selectedIds = Array.from(document.querySelectorAll('.sel:checked')).map(cb => parseInt(cb.value));
      const selected = currentPost.images.filter(img => selectedIds.includes(img.id));
      await downloadImages(selected, 'selected');
    }

    async function downloadAll() {
      if (!currentPost) return;
      await downloadImages(currentPost.images, 'all');
    }

    async function ensureAuth() {
      const cfg = await (await fetch('/api/public-config')).json();
      const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
      const supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey, { auth: { persistSession: true } });
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { location.href = '/login.html'; return null; }
      return session.user.email;
    }

    async function saveSelected() {
      if (!currentPost) return;
      const selectedIds = Array.from(document.querySelectorAll('.sel:checked')).map(cb => parseInt(cb.value));
      const selected = currentPost.images.filter(img => selectedIds.includes(img.id));
      if (selected.length === 0) return;
      if (!currentUserEmail) currentUserEmail = await ensureAuth();
      if (!currentUserEmail) return;
      const name = prompt('Name this post:');
      if (!name) return;
      const caption = prompt('Optional caption:') || '';
      const res = await fetch('/api/saved-posts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, caption, images: selected, owner_email: currentUserEmail }) });
      const data = await res.json();
      if (data?.success) {
        if (confirm('Saved! Open it now?')) location.href = `/saved-view.html?id=${data.id}`;
      } else {
        alert(data?.error || 'Save failed');
      }
    }

    document.getElementById('generate').onclick = generate;
    document.getElementById('rerollSelected').onclick = rerollSelected;
    document.getElementById('downloadSelected').onclick = downloadSelected;
    document.getElementById('downloadAll').onclick = downloadAll;
    document.getElementById('saveSelected').onclick = saveSelected;
  </script>
</main>
</body>
</html>


