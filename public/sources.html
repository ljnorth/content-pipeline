<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Source Accounts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/style.css">
</head>
<body>
  <header class="nav"><div class="nav-inner">
    <div class="brand"><span class="dot"></span> EasyPost</div>
    <div class="nav-links">
      <a href="/">Home</a>
      <a href="/managed.html">Managed</a>
      <a href="/sources.html">Sources</a>
      <a href="/random.html">Random</a>
      <a href="/saved.html">Saved</a>
      <a href="/docs.html">Docs</a>
      <a href="/logout.html">Logout</a>
    </div>
  </div></header>
  <main>
    <h2>Source Accounts</h2>
    <div id="authStatus" class="muted" style="margin-bottom:8px">Checking session…</div>

    <div class="row section">
      <input id="susername" placeholder="@username"/>
      <input id="surl" placeholder="Profile URL (optional)"/>
      <input id="stags" placeholder="Tags (comma separated)"/>
      <select id="sgender">
        <option value="">Gender (optional)</option>
        <option value="men">Men</option>
        <option value="women">Women</option>
      </select>
      <label class="muted"><input type="checkbox" id="sactive" checked/> Active</label>
      <button id="addSource" class="btn btn-primary">Add / Update Source</button>
      <button id="bulk" class="btn btn-outline">Bulk Add</button>
      <button id="ingestAll" class="btn btn-outline">Ingest All (Delta)</button>
    </div>

    <table>
      <thead><tr>
        <th><input type="checkbox" id="selectAll"/></th>
        <th>Username</th><th>URL</th><th>Tags</th><th>Active</th><th>Actions</th>
      </tr></thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="row section">
      <button id="pauseSel" class="btn btn-outline">Pause Selected</button>
      <button id="resumeSel" class="btn btn-outline">Resume Selected</button>
      <button id="ingestSel" class="btn btn-outline">Ingest Selected (Delta)</button>
    </div>

    <div class="section">
      <div class="card white">
        <h3>Top Source Usage</h3>
        <div id="usage" class="muted">Loading…</div>
      </div>
    </div>

    <script type="module">
      import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
      async function loadConfig(){ const r = await fetch('/api/public-config'); return await r.json(); }

      async function loadSources(){
        const res = await fetch('/api/sources');
        const data = await res.json();
        const tbody = document.getElementById('rows'); tbody.innerHTML='';
        (data||[]).forEach(a=>{
          const tr = document.createElement('tr');
          const tags = Array.isArray(a.tags) ? a.tags.join(', ') : '';
          tr.innerHTML = `<td><input type="checkbox" class="sel" data-u="${a.username}"></td>`+
            `<td>@${a.username}</td><td>${a.url||''}</td><td>${tags}</td><td>${a.active?'Yes':'No'}</td>
            <td>
              <button class="btn btn-outline ingest" data-u="${a.username}">Ingest Delta</button>
              <button class="btn btn-outline ingest-new" data-u="${a.username}">Ingest New</button>
              <button class="btn btn-outline toggle" data-u="${a.username}" data-active="${a.active}">${a.active?'Pause':'Resume'}</button>
              <button class="btn btn-outline del" data-u="${a.username}">Remove</button>
            </td>`;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('button.ingest').forEach(btn=>{ btn.onclick=async()=>{ await fetch('/api/ingest?mode=delta&username='+encodeURIComponent(btn.dataset.u)); }; });
        document.querySelectorAll('button.ingest-new').forEach(btn=>{ btn.onclick=async()=>{ await fetch('/api/ingest?mode=new&username='+encodeURIComponent(btn.dataset.u)); }; });
        document.querySelectorAll('button.toggle').forEach(btn=>{ btn.onclick=async()=>{
            const makeActive = /resume/i.test(btn.textContent);
            await fetch('/api/sources',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:btn.dataset.u,active:makeActive})});
            loadSources();
        }; });
        document.querySelectorAll('button.del').forEach(btn=>{ btn.onclick=async()=>{ await fetch('/api/sources?username='+encodeURIComponent(btn.dataset.u),{method:'DELETE'}); loadSources(); }; });
      }

      document.getElementById('addSource').onclick = async ()=>{
        const username = document.getElementById('susername').value.replace('@','');
        const url = document.getElementById('surl').value; const tags = document.getElementById('stags').value.split(',').map(s=>s.trim()).filter(Boolean);
        const gender = document.getElementById('sgender').value;
        const active = document.getElementById('sactive').checked;
        await fetch('/api/sources',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,url,tags,active,gender})});
        loadSources();
      };

      document.getElementById('ingestAll').onclick = async ()=>{ await fetch('/api/ingest?mode=all'); };

      // Bulk Add UI (simple prompt for now)
      document.getElementById('bulk').onclick = async ()=>{
        const pasted = prompt('Paste one per line: @username, url?, tags? (comma separated tags)');
        if (!pasted) return;
        const lines = pasted.split('\n').map(l=>l.trim()).filter(Boolean);
        for (const line of lines) {
          const parts = line.split(',').map(s=>s.trim());
          const username = parts[0].replace('@','');
          const url = parts[1] || '';
          const tags = parts.slice(2).filter(Boolean);
          await fetch('/api/sources',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,url,tags,active:true,gender:document.getElementById('sgender').value})});
        }
        loadSources();
      };

      // Auth guard
      const cfg = await loadConfig();
      const supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey, { auth: { persistSession: true } });
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { document.getElementById('authStatus').textContent = 'Not logged in. Redirecting to login…'; setTimeout(()=> location.href = '/login.html', 800); }
      else { 
        document.getElementById('authStatus').textContent = `Logged in as ${session.user.email}`; 
        loadSources();
        const u = await (await fetch('/api/analytics/source-usage?limit=10')).json();
        document.getElementById('usage').innerHTML = (u||[]).map(x=>`@${x.source_username}: ${x.used_count}`).join('<br>') || 'No usage yet';
      }

      // Bulk select helpers
      document.getElementById('selectAll').onclick = () => {
        const on = document.getElementById('selectAll').checked;
        document.querySelectorAll('.sel').forEach(cb => cb.checked = on);
      };
      function selected() { return Array.from(document.querySelectorAll('.sel:checked')).map(cb => cb.dataset.u); }
      document.getElementById('pauseSel').onclick = async () => {
        const users = selected(); if (users.length===0) return;
        await Promise.all(users.map(u => fetch('/api/sources',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,active:false})})));
        loadSources();
      };
      document.getElementById('resumeSel').onclick = async () => {
        const users = selected(); if (users.length===0) return;
        await Promise.all(users.map(u => fetch('/api/sources',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,active:true})})));
        loadSources();
      };
      document.getElementById('ingestSel').onclick = async () => {
        const users = selected(); if (users.length===0) return;
        for (const u of users) await fetch('/api/ingest?mode=delta&username='+encodeURIComponent(u));
      };
  </script>
  <footer class="center" style="gap:12px;margin:24px 0">
    <a href="/privacy.html">Privacy</a>
    <span class="muted">•</span>
    <a href="/tos.html">Terms</a>
  </footer>
  </main>
</body>
</html>


