<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Source Accounts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/style.css">
</head>
<body>
  <header class="nav"><div class="nav-inner">
    <div class="brand"><span class="dot"></span> EasyPost</div>
    <div class="nav-links">
      <a href="/">Home</a>
      <a href="/managed.html">Managed</a>
      <a href="/sources.html">Sources</a>
      <a href="/performance.html">Performance</a>
      <a href="/random.html">Random</a>
      <a href="/saved.html">Saved</a>
      <a href="/docs.html">Docs</a>
      <a href="/logout.html">Logout</a>
    </div>
  </div></header>
  <main>
    <h2>Source Accounts</h2>
    <div id="authStatus" class="muted" style="margin-bottom:8px">Checking session‚Ä¶</div>
    <div class="row" style="margin-bottom:12px">
      <div class="card white" style="flex:1; margin-right:8px">
        <div class="muted">Total Sources</div>
        <div id="kpiSources" class="big">0</div>
      </div>
      <div class="card white" style="flex:1">
        <div class="muted">Last Pipeline Activity</div>
        <div id="kpiLastRun" class="big">‚Äî</div>
      </div>
      <div class="card white" style="flex:1">
        <div class="muted">Gender Mix</div>
        <div id="kpiGender" class="big">‚Äî</div>
      </div>
    </div>

    <div class="row section">
      <input id="susername" placeholder="@username"/>
      <input id="surl" placeholder="Profile URL (optional)"/>
      <input id="stags" placeholder="Tags (comma separated)"/>
      <select id="sgender">
        <option value="">Gender (optional)</option>
        <option value="men">Men</option>
        <option value="women">Women</option>
      </select>
      <label class="muted"><input type="checkbox" id="sactive" checked/> Active</label>
      <button id="addSource" class="icon-btn" title="Add / Update Source" aria-label="Add / Update Source">‚ûï</button>
      <button id="bulk" class="icon-btn" title="Bulk Add" aria-label="Bulk Add">üìã</button>
      <button id="ingestAll" class="icon-btn" title="Ingest All (Delta)" aria-label="Ingest All (Delta)">‚Üª</button>
    </div>
    <div id="statusBar" class="muted" style="margin:-4px 0 12px 0"></div>

    <table>
      <thead><tr>
        <th><input type="checkbox" id="selectAll"/></th>
        <th>Username</th><th>URL</th><th>Tags</th><th>Gender</th><th>Active</th><th>Actions</th>
      </tr></thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="row section">
      <button id="pauseSel" class="icon-btn" title="Pause Selected" aria-label="Pause Selected">‚è∏</button>
      <button id="resumeSel" class="icon-btn" title="Resume Selected" aria-label="Resume Selected">‚ñ∂</button>
      <button id="ingestSel" class="icon-btn" title="Ingest Selected (Delta)" aria-label="Ingest Selected (Delta)">‚Üª</button>
    </div>

    <div class="section">
      <div class="card white">
        <h3>Top Source Usage</h3>
        <div id="usage" class="muted">Loading‚Ä¶</div>
      </div>
    </div>

    <script type="module">
      import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
      async function loadConfig(){ const r = await fetch('/api/public-config'); return await r.json(); }

      async function loadSources(){
        const res = await fetch('/api/sources');
        const data = await res.json();
        const tbody = document.getElementById('rows'); tbody.innerHTML='';
        (data||[]).forEach(a=>{
          const tr = document.createElement('tr');
          const tags = Array.isArray(a.tags) ? a.tags.join(', ') : '';
          const gender = Array.isArray(a.tags) ? (a.tags.includes('men') ? 'men' : (a.tags.includes('women') ? 'women' : '')) : '';
          tr.innerHTML = `<td><input type=\"checkbox\" class=\"sel\" data-u=\"${a.username}\"></td>`+
            `<td class=\"col-user\">@${a.username}</td><td class=\"col-url\">${a.url||''}</td><td class=\"col-tags\">${tags}</td><td class=\"col-gender\">${gender}</td><td class=\"col-active\">${a.active?'Yes':'No'}</td>
            <td>
              <button class="icon-btn ingest" data-u="${a.username}" title="Ingest Delta" aria-label="Ingest Delta">‚Üª</button>
              <button class="icon-btn ingest-new" data-u="${a.username}" title="Ingest New" aria-label="Ingest New">‚ûï</button>
              <button class="icon-btn toggle" data-u="${a.username}" data-active="${a.active}" data-next="${a.active?'pause':'resume'}" title="${a.active?'Pause':'Resume'}" aria-label="${a.active?'Pause':'Resume'}">${a.active?'‚è∏':'‚ñ∂'}</button>
              <button class="icon-btn edit" data-u="${a.username}" title="Edit" aria-label="Edit">‚úé</button>
              <button class="icon-btn del" data-u="${a.username}" title="Remove" aria-label="Remove">üóë</button>
            </td>`;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('button.ingest').forEach(btn=>{ btn.onclick=async()=>{ await fetch('/api/ingest?mode=delta&username='+encodeURIComponent(btn.dataset.u)); }; });
        document.querySelectorAll('button.ingest-new').forEach(btn=>{ btn.onclick=async()=>{ await fetch('/api/ingest?mode=new&username='+encodeURIComponent(btn.dataset.u)); }; });
        document.querySelectorAll('button.toggle').forEach(btn=>{ btn.onclick=async()=>{
            const makeActive = btn.dataset.next === 'resume';
            await fetch('/api/sources',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:btn.dataset.u,active:makeActive})});
            loadSources();
        }; });
        document.querySelectorAll('button.del').forEach(btn=>{ btn.onclick=async()=>{ await fetch('/api/sources?username='+encodeURIComponent(btn.dataset.u),{method:'DELETE'}); loadSources(); }; });

        // Inline edit for sources
        document.querySelectorAll('button.edit').forEach(btn=>{
          btn.onclick = () => startEditSource(btn.closest('tr'));
        });

        // KPIs
        setKpiSources((data||[]).length);
        loadLastRunKpi();
        setKpiGenderFromSources(data||[]);
      }

      document.getElementById('addSource').onclick = async ()=>{
        const username = document.getElementById('susername').value.replace('@','');
        const url = document.getElementById('surl').value; const tags = document.getElementById('stags').value.split(',').map(s=>s.trim()).filter(Boolean);
        const gender = document.getElementById('sgender').value;
        const active = document.getElementById('sactive').checked;
        if (!username){ return setStatus('Please enter a username','err'); }
        const exists = await (await fetch('/api/sources?username='+encodeURIComponent(username))).json();
        if (Array.isArray(exists) && exists.length>0){ return setStatus(`@${username} already exists. Use Edit to update.`, 'warn'); }
        const r = await fetch('/api/sources',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,url,tags,active,gender})});
        if (r.ok){ setStatus(`Added @${username} successfully`, 'ok'); document.getElementById('susername').value=''; document.getElementById('surl').value=''; document.getElementById('stags').value=''; document.getElementById('sgender').value=''; document.getElementById('sactive').checked=true; loadSources(); }
        else { const j = await r.json().catch(()=>({})); setStatus(j.error||'Failed to add source','err'); }
      };

      document.getElementById('ingestAll').onclick = async ()=>{ await fetch('/api/ingest?mode=all'); };

      // Bulk Add UI (simple prompt for now)
      document.getElementById('bulk').onclick = async ()=>{
        const pasted = prompt('Paste one per line: @username, url?, tags? (comma separated tags)');
        if (!pasted) return;
        const lines = pasted.split('\n').map(l=>l.trim()).filter(Boolean);
        for (const line of lines) {
          const parts = line.split(',').map(s=>s.trim());
          const username = parts[0].replace('@','');
          const url = parts[1] || '';
          const tags = parts.slice(2).filter(Boolean);
          await fetch('/api/sources',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,url,tags,active:true,gender:document.getElementById('sgender').value})});
        }
        loadSources();
      };

      function startEditSource(tr){
        const username = tr.querySelector('.col-user').textContent.replace('@','').trim();
        const url = tr.querySelector('.col-url').textContent.trim();
        const tags = tr.querySelector('.col-tags').textContent.trim();
        const genderText = tr.querySelector('.col-gender').textContent.trim() || '';
        const active = /Yes/i.test(tr.querySelector('.col-active').textContent);
        const actions = tr.querySelector('td:last-child');

        tr.querySelector('.col-url').innerHTML = `<input class="inline url" value="${escapeHtml(url)}" style="width:95%"/>`;
        tr.querySelector('.col-tags').innerHTML = `<input class="inline tags" value="${escapeHtml(tags)}" style="width:95%"/>`;
        tr.querySelector('.col-gender').innerHTML = `<select class="inline gender" style="width:95%">
          <option value="" ${genderText===''?'selected':''}></option>
          <option value="men" ${genderText==='men'?'selected':''}>men</option>
          <option value="women" ${genderText==='women'?'selected':''}>women</option>
        </select>`;
        tr.querySelector('.col-active').innerHTML = `<label><input type="checkbox" class="inline active" ${active?'checked':''}/> Active</label>`;
        actions.innerHTML = `<button class="btn btn-primary save">Save</button> <button class="btn btn-outline cancel">Cancel</button>`;

        actions.querySelector('.save').onclick = async () => {
          // Remove any gender tokens from tags; send chosen gender separately
          const rawTags = tr.querySelector('.tags').value.split(',').map(s=>s.trim()).filter(Boolean);
          const nonGenderTags = rawTags.filter(t => t.toLowerCase() !== 'men' && t.toLowerCase() !== 'women');
          const body = {
            username,
            url: tr.querySelector('.url').value,
            tags: nonGenderTags,
            active: tr.querySelector('.active').checked,
            gender: tr.querySelector('.gender').value
          };
          try {
            // Use PATCH when only toggling active; otherwise POST upsert
            await fetch('/api/sources',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
            await loadSources();
          } catch(e){ alert('Save failed: '+e.message); }
        };
        actions.querySelector('.cancel').onclick = () => loadSources();
      }

      function escapeHtml(s){
        return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      }

      // Auth guard
      const cfg = await loadConfig();
      const supabase = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey, { auth: { persistSession: true } });
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { document.getElementById('authStatus').textContent = 'Not logged in. Redirecting to login‚Ä¶'; setTimeout(()=> location.href = '/login.html', 800); }
      else { 
        document.getElementById('authStatus').textContent = `Logged in as ${session.user.email}`; 
        loadSources();
        const u = await (await fetch('/api/analytics/source-usage?limit=10')).json();
        document.getElementById('usage').innerHTML = (u||[]).map(x=>`@${x.source_username}: ${x.used_count}`).join('<br>') || 'No usage yet';
      }

      // Bulk select helpers
      document.getElementById('selectAll').onclick = () => {
        const on = document.getElementById('selectAll').checked;
        document.querySelectorAll('.sel').forEach(cb => cb.checked = on);
      };
      function selected() { return Array.from(document.querySelectorAll('.sel:checked')).map(cb => cb.dataset.u); }
      document.getElementById('pauseSel').onclick = async () => {
        const users = selected(); if (users.length===0) return;
        await Promise.all(users.map(u => fetch('/api/sources',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,active:false})})));
        loadSources();
      };
      document.getElementById('resumeSel').onclick = async () => {
        const users = selected(); if (users.length===0) return;
        await Promise.all(users.map(u => fetch('/api/sources',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,active:true})})));
        loadSources();
      };
      document.getElementById('ingestSel').onclick = async () => {
        const users = selected(); if (users.length===0) return;
        for (const u of users) await fetch('/api/ingest?mode=delta&username='+encodeURIComponent(u));
      };

      function setStatus(text, kind){
        const el = document.getElementById('statusBar'); el.textContent=text; el.style.color = kind==='err'? '#b00020' : (kind==='ok'? '#2e7d32' : (kind==='warn'? '#d99100' : '#666'));
      }
      function setKpiSources(n){ document.getElementById('kpiSources').textContent = String(n); }
      async function loadLastRunKpi(){
        try{
          const types=['weekly_ingest','discover_owned_posts','fetch_post_metrics'];
          const arr = await Promise.all(types.map(t=> fetch('/api/runs?job_type='+t+'&limit=1').then(r=>r.json()).catch(()=>({runs:[]}))));
          const dates = arr.flatMap(r=> (r.runs||[]).map(x=> x.created_at)).filter(Boolean);
          document.getElementById('kpiLastRun').textContent = dates.length? new Date(dates.sort().pop()).toLocaleString() : '‚Äî';
        }catch{ document.getElementById('kpiLastRun').textContent='‚Äî'; }
      }

      function setKpiGenderFromSources(list){
        try{
          const total = (list||[]).length;
          if (!total){ document.getElementById('kpiGender').textContent = '‚Äî'; return; }
          let men=0, women=0, unlabeled=0;
          for (const a of list){
            const tags = Array.isArray(a.tags) ? a.tags.map(t=> String(t).toLowerCase()) : [];
            const hasMen = tags.includes('men');
            const hasWomen = tags.includes('women');
            if (hasMen && hasWomen){ men += 0.5; women += 0.5; }
            else if (hasMen){ men += 1; }
            else if (hasWomen){ women += 1; }
            else { unlabeled += 1; }
          }
          const pct = (x)=> Math.round((x/total)*100);
          const parts = [];
          if (women) parts.push(`Women ${pct(women)}%`);
          if (men) parts.push(`Men ${pct(men)}%`);
          if (unlabeled) parts.push(`Unlabeled ${pct(unlabeled)}%`);
          document.getElementById('kpiGender').textContent = parts.join(' ‚Ä¢ ') || '‚Äî';
        } catch { document.getElementById('kpiGender').textContent = '‚Äî'; }
      }
  </script>
  <footer class="center" style="gap:12px;margin:24px 0">
    <a href="/privacy.html">Privacy</a>
    <span class="muted">‚Ä¢</span>
    <a href="/tos.html">Terms</a>
  </footer>
  </main>
</body>
</html>


