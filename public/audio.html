<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Audio Uploader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/assets/style.css"/>
</head>
<body>
  <header class="nav"><div class="nav-inner"><div class="brand"><span class="dot"></span> Audio Uploader</div></div></header>
  <main class="section">
    <h2>Bulk Upload Meme Audio</h2>
    <div class="card white">
      <div class="row" style="gap:8px;align-items:center">
        <input type="file" id="files" accept="audio/*" multiple />
        <select id="gender"><option value="both">both</option><option value="female">female</option><option value="male">male</option></select>
        <input id="vibe" placeholder="vibe (optional)"/>
        <button id="upload" class="btn btn-primary">Upload</button>
        <div id="status" class="muted"></div>
      </div>
      <div id="list" class="muted" style="margin-top:8px"></div>
    </div>
  </main>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    async function loadConfig(){ const r = await fetch('/api/public-config'); return await r.json(); }
    const cfg = await loadConfig();
    const sb = createClient(cfg.supabaseUrl, cfg.supabaseAnonKey, { auth: { persistSession: true } });
    const files = document.getElementById('files');
    const btn = document.getElementById('upload');
    const status = document.getElementById('status');
    const list = document.getElementById('list');
    function setStatus(s){ status.textContent = s; }
    btn.onclick = async () => {
      const gender = document.getElementById('gender').value;
      const vibe = document.getElementById('vibe').value.trim();
      const sel = Array.from(files.files||[]);
      if (!sel.length) return setStatus('Pick audio files first');
      setStatus('Uploading...');
      const items = [];
      for (const f of sel){
        const key = `character-assets/audio/${Date.now()}_${Math.random().toString(36).slice(2)}_${f.name}`;
        const up = await sb.storage.from('character-assets').upload(key, f, { contentType: f.type, upsert:false }).catch(()=>({error:{message:'upload failed'}}));
        if (up.error){ setStatus('Upload failed: '+up.error.message); return; }
        const { data } = sb.storage.from('character-assets').getPublicUrl(key);
        items.push({ url: data.publicUrl, title: f.name, duration_sec: null, vibe, bpm: null, gender });
      }
      const r = await fetch('/api/audio/save', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ items }) });
      const j = await r.json();
      if (!r.ok || j.success!==true) { setStatus('Save failed: '+(j.error||'-')); return; }
      list.textContent = `Saved ${j.count} audios.`;
      setStatus('Done');
    };
  </script>
</body>
</html>


